<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spoon Bowl 2026 Draft</title>

<style>
:root{
  --bgTop:#0a2416;
  --bgMid:#0f3a22;
  --bgBot:#145c34;
  --card: rgba(255,255,255,.08);
  --line: rgba(255,255,255,.10);
  --shadow: 0 30px 80px rgba(0,0,0,.55);
  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.72);
  --accent: #7CFFB7;
}

*{box-sizing:border-box}

body{
  margin:0;
  min-height:100vh;
  font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial;
  color: var(--text);
  background:
    radial-gradient(1200px 700px at 50% 0%, rgba(124,255,183,.18), transparent 60%),
    radial-gradient(900px 500px at 50% 20%, rgba(255,255,255,.08), transparent 60%),
    linear-gradient(180deg, var(--bgTop), var(--bgMid) 45%, var(--bgBot));
  -webkit-user-select:none;
  user-select:none;
}

.wrap{
  max-width:980px;
  margin:auto;
  padding:22px 16px 60px;
}

.hero{
  border-radius:24px;
  overflow:hidden;
  background:var(--card);
  border:1px solid var(--line);
  box-shadow:var(--shadow);
}

.hero img{width:100%;display:block}

.heroText{
  text-align:center;
  padding:18px 16px 20px;
  background:linear-gradient(180deg, rgba(0,0,0,.18), rgba(0,0,0,.35));
}

h1{
  margin:0 0 8px;
  font-size:clamp(28px,6vw,42px);
  font-weight:950;
  letter-spacing:.7px;
}

.sub{
  margin:0 0 12px;
  color:var(--muted);
  font-weight:750;
}

.meta{
  margin:18px auto 10px;
  max-width:900px;
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.metaBox{
  padding:14px 12px;
  border-radius:16px;
  background:rgba(0,0,0,.25);
  border:1px solid rgba(255,255,255,.10);
  text-align:center;
  font-weight:850;
}

.metaBox strong{
  display:block;
  font-size:18px;
  margin-top:6px;
  letter-spacing:.4px;
  color:var(--accent);
  word-break:break-word;
}

.section{
  text-align:center;
  margin:22px 0 10px;
  font-weight:950;
  letter-spacing:.7px;
  text-transform:uppercase;
}

.board{
  max-width:860px;
  margin:auto;
  border-radius:20px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.10);
  background:rgba(0,0,0,.20);
  box-shadow:0 20px 55px rgba(0,0,0,.45);
}

.row{
  display:flex;
  align-items:center;
  gap:14px;
  padding:14px 16px;
  border-top:1px solid rgba(255,255,255,.08);
  background:rgba(0,0,0,.18);
  font-weight:850;
}
.row:first-child{border-top:none}

.num{
  width:44px;height:44px;
  display:grid;place-items:center;
  border-radius:12px;
  background:rgba(124,255,183,.14);
  border:1px solid rgba(124,255,183,.24);
  color:var(--accent);
  font-weight:950;
}

.name.hidden{opacity:.55}
.name.reveal{opacity:1}

.footer{
  text-align:center;
  margin-top:12px;
  color:rgba(255,255,255,.60);
  font-size:13px;
  line-height:1.35;
}

.small{
  text-align:center;
  margin-top:10px;
  color:rgba(255,255,255,.70);
  font-size:12px;
  line-height:1.35;
}
a{color:var(--accent)}
button{
  margin-top:8px;
  border:1px solid rgba(255,255,255,.18);
  background:rgba(0,0,0,.30);
  color:rgba(255,255,255,.92);
  padding:8px 10px;
  border-radius:10px;
  font-weight:800;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="hero">
    <img src="banner.jpg" alt="Spoon Bowl 2026">
    <div class="heroText">
      <h1>SPOON BOWL 2026 DRAFT</h1>
      <p class="sub">Randomized draft order reveal</p>
    </div>
  </div>

  <div class="meta">
    <div class="metaBox">Reveal Time (Brisbane AEST)<strong id="revealLabel">Sunday 4:30 PM</strong></div>
    <div class="metaBox">Countdown<strong id="count">--:--:--</strong></div>
    <div class="metaBox">Randomness Proof (Drand Round)<strong id="proofRound">Pending</strong></div>
    <div class="metaBox">Randomness Value<strong id="proofRand">Pending</strong></div>
  </div>

  <div class="section">Draft Order</div>
  <div class="board" id="board"></div>

  <div class="footer">Randomized draft order • Revealed one pick at a time (2s)</div>

  <div class="small" id="proofText"></div>
  <div class="small"><button id="copyBtn" type="button">Copy proof</button></div>

</div>

<script>
/* =========================
   Teams (plain text)
========================= */
const TEAMS = [
  "Hakuna Mata'utia",
  "Spooners6",
  "CSFC91",
  "Schmidsgoat",
  "SeaEaglesChamps2025",
  "Nate’s Stars",
  "Multiple Scoregasams",
  "Strat",
  "The Casualty Ward Deadbeats",
  "irhysistable"
];

/* =========================
   UI board
========================= */
const board = document.getElementById("board");
const nameEls = [];
for (let i=0;i<TEAMS.length;i++){
  const r=document.createElement("div");
  r.className="row";
  r.innerHTML = `<div class="num">${i+1}</div><div class="name hidden">Hidden</div>`;
  board.appendChild(r);
  nameEls.push(r.querySelector(".name"));
}

const countEl = document.getElementById("count");
const proofRoundEl = document.getElementById("proofRound");
const proofRandEl  = document.getElementById("proofRand");
const proofTextEl  = document.getElementById("proofText");
const copyBtn      = document.getElementById("copyBtn");

/* =========================
   Time: next Sunday 4:30pm Brisbane (AEST = UTC+10, no DST)
   Everyone sees the same UTC timestamp.
========================= */
const AEST_OFFSET_MS = 10 * 60 * 60 * 1000;

function nextSunday430_BrisbaneUTC(){
  const nowUTC = Date.now();
  const nowAEST = new Date(nowUTC + AEST_OFFSET_MS); // pretend local = AEST

  // Build target in that "AEST view"
  const targetAEST = new Date(nowAEST);
  targetAEST.setSeconds(0,0);
  targetAEST.setHours(16,30,0,0);

  // Move to Sunday
  while (targetAEST.getDay() !== 0) targetAEST.setDate(targetAEST.getDate()+1);

  // If already passed in AEST, go next week
  if (targetAEST.getTime() <= nowAEST.getTime()) targetAEST.setDate(targetAEST.getDate()+7);

  // Convert back to UTC ms
  return targetAEST.getTime() - AEST_OFFSET_MS;
}

const REVEAL_UTC = nextSunday430_BrisbaneUTC();

/* =========================
   Drand: compute a fixed round from reveal time
   so everyone fetches the SAME round.
========================= */
const DRAND_INFO = "https://api.drand.sh/public/info";
const DRAND_ROUND = (r) => `https://api.drand.sh/public/${r}`;

async function fetchJSON(url){
  const res = await fetch(url, { cache: "no-store" });
  if (!res.ok) throw new Error("fetch failed");
  return res.json();
}

function computeRound(genesisTimeSec, periodSec, targetUnixSec){
  // rounds are 1-indexed in drand
  return Math.floor((targetUnixSec - genesisTimeSec) / periodSec) + 1;
}

async function getDrandProofForReveal(){
  // cache in localStorage so refresh can't change proof
  const k = "sb26_drand_proof_v1";
  const saved = localStorage.getItem(k);
  if (saved){
    try{ return JSON.parse(saved); }catch(e){}
  }

  const info = await fetchJSON(DRAND_INFO);
  const genesis = Number(info.genesis_time);   // seconds
  const period  = Number(info.period);         // seconds
  const targetRound = computeRound(genesis, period, Math.floor(REVEAL_UTC/1000));

  // poll until the target round exists (after reveal time it will appear)
  while(true){
    try{
      const p = await fetchJSON(DRAND_ROUND(targetRound));
      const proof = { round: p.round, randomness: p.randomness };
      localStorage.setItem(k, JSON.stringify(proof));
      return proof;
    }catch(e){
      // If not ready yet, wait a bit and try again
      await new Promise(r => setTimeout(r, 1500));
    }
  }
}

/* =========================
   Deterministic shuffle from a seed string
========================= */
function xmur3(str){
  let h = 1779033703 ^ str.length;
  for (let i=0;i<str.length;i++){
    h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
    h = (h << 13) | (h >>> 19);
  }
  return function(){
    h = Math.imul(h ^ (h >>> 16), 2246822507);
    h = Math.imul(h ^ (h >>> 13), 3266489909);
    return (h ^= h >>> 16) >>> 0;
  }
}
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function shuffleSeeded(arr, seedStr){
  const seedFn = xmur3(seedStr);
  const rnd = mulberry32(seedFn());
  const a = arr.slice();
  for (let i=a.length-1;i>0;i--){
    const j = Math.floor(rnd()*(i+1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/* =========================
   Lock order globally (deterministic) + lock locally (no reroll on refresh)
========================= */
const ORDER_KEY = "sb26_order_provable_v1";
const START_KEY = "sb26_start_provable_v1";

function getStart(){
  const v = Number(localStorage.getItem(START_KEY) || 0);
  return v > 0 ? v : null;
}
function setStart(ts){
  localStorage.setItem(START_KEY, String(ts));
}

function getOrder(){
  const saved = localStorage.getItem(ORDER_KEY);
  if(saved){
    try{
      const p = JSON.parse(saved);
      if(Array.isArray(p) && p.length === TEAMS.length) return p;
    }catch(e){}
  }
  return null;
}
function setOrder(o){
  localStorage.setItem(ORDER_KEY, JSON.stringify(o));
}

/* =========================
   Countdown + reveal
========================= */
const INTERVAL_MS = 2000;

function pad(n){ return String(n).padStart(2,"0"); }

function render(order){
  const start = getStart();
  if(!start) return;

  const shown = Math.min(order.length, Math.floor((Date.now() - start)/INTERVAL_MS) + 1);

  for(let i=0;i<order.length;i++){
    if(i < shown){
      nameEls[i].textContent = order[i];
      nameEls[i].classList.remove("hidden");
      nameEls[i].classList.add("reveal");
    }
  }
}

async function startIfNeeded(){
  // If order already locked, just render
  const existing = getOrder();
  if(existing){
    render(existing);
    return;
  }

  // Fetch public proof, then create deterministic order
  const proof = await getDrandProofForReveal();
  proofRoundEl.textContent = String(proof.round);
  proofRandEl.textContent  = proof.randomness;

  // Seed: fixed reveal time + proof fields + teams list (so any mismatch is obvious)
  const seed = `${REVEAL_UTC}|${proof.round}|${proof.randomness}|${TEAMS.join("|")}`;
  const order = shuffleSeeded(TEAMS, seed);

  setOrder(order);
  render(order);

  // Proof text for mates
  proofTextEl.innerHTML =
    `Proof URL: <a href="https://api.drand.sh/public/${proof.round}" target="_blank" rel="noopener">api.drand.sh/public/${proof.round}</a><br>` +
    `Seed = REVEAL_UTC + round + randomness + team list (deterministic shuffle)`;
}

function tick(){
  const diff = REVEAL_UTC - Date.now();
  if(diff <= 0){
    countEl.textContent = "00:00:00";
    if(!getStart()) setStart(Date.now());
    startIfNeeded();
    return;
  }

  const h = Math.floor(diff/36e5);
  const m = Math.floor((diff%36e5)/6e4);
  const s = Math.floor((diff%6e4)/1e3);
  countEl.textContent = `${pad(h)}:${pad(m)}:${pad(s)}`;

  // If someone refreshed after reveal started, keep it going
  const existing = getOrder();
  if(existing) render(existing);
}

setInterval(tick, 500);
tick();

/* Copy proof button */
copyBtn.addEventListener("click", async () => {
  const proof = localStorage.getItem("sb26_drand_proof_v1");
  const order = localStorage.getItem(ORDER_KEY);
  const msg =
`Spoon Bowl 2026 Draft – Random Proof
Reveal UTC: ${REVEAL_UTC}
Drand proof: ${proof || "pending"}
Proof URL: https://api.drand.sh/public/(round shown on page)
Order (locked): ${order || "pending"}`;
  try{
    await navigator.clipboard.writeText(msg);
    copyBtn.textContent = "Copied!";
    setTimeout(()=>copyBtn.textContent="Copy proof", 1200);
  }catch(e){
    alert("Couldn’t copy automatically — select and copy from the Proof section.");
  }
});
</script>
</body>
</html>
